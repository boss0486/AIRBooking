@using WebCore.Entities;
@using WebCore.Services;
@using WebCore.Model.Enum;
@using WebCore.Model.Services;
@using WebCore.ENM;
@{
    ViewBag.Title = Helper.Page.MetaSEO.MetaTitle;
}
@model  WebCore.Entities.ViewBookOrder
@{
    try
    {
        if (Model != null)
        {
            List<BookTicket> bookTickets = Model.BookTickets;
            List<BookPassenger> bookPassengers = Model.BookPassengers;
            List<BookPrice> bookPrices = Model.BookPrices;
            List<BookTax> bookTaxes = Model.BookTaxs;
            List<BookContact> bookContacts = Model.BookContacts;
            <section>
                <div class="form-group mgb-20">
                    <label>THÔNG TIN ĐẶT VÉ:</label>
                </div>
                <div class="form-group mgb-20">
                    <label id="lblPNRCode" data-pnr="@Model.PNR" style="color:#ff0000; font-size:16px;"><i style="color:#ff0000; font-size:16px;" class="fas fa-qrcode"></i> PNR: @Model.PNR</label>
                </div>
                <div class="table-responsive mgb-20">
                    <table id="TblFlight" class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Hãng</th>
                                <th>Số hiệu</th>
                                <th>Hành trình</th>
                                <th>Ngày bay</th>
                                <th>Giờ xuất phát</th>
                                <th>Giờ đến</th>
                                <th class="text-center">Hạng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (bookTickets != null && bookTickets.Count() > 0)
                            {
                                foreach (var item in bookTickets)
                                {
                                    <tr>
                                        <td>

                                            <label class="lblTrademark">VNA</label>
                                        </td>
                                        <td>
                                            <i class="fa fa-plane" aria-hidden="true"></i> <label class="lblFlightNo">VN @item.AirEquipType</label> <label>@item.FlightNumber</label>
                                        </td>
                                        <td>
                                            <label class="lblItinerary">@item.OriginLocation - @item.DestinationLocation; @item.DepartureDateTime.ToString("dd-MM-yyyy")</label>
                                        </td>
                                        <td>
                                            <span class="lblItineraryTime">@item.DepartureDateTime.ToString("dd-MM-yyyy")</span>
                                        </td>
                                        <td>
                                            <span class="lblItineraryTime">@item.DepartureDateTime.ToString("HH:mm:ss")</span>
                                        </td>
                                        <td>
                                            <span class="lblItineraryTime">@item.ArrivalDateTime.ToString("HH:mm:ss")</span>
                                        </td>
                                        <td class="text-center">
                                            <label class="lblResbookdesigcode">@item.ResBookDesigCode</label>
                                        </td>
                                    </tr>
                                }
                            }

                        </tbody>
                    </table>
                </div>
                <div class="top-pic mgb-10">
                    <label><i class="fa fa-info-circle" aria-hidden="true"></i> Thông tin hành khách:</label>
                </div>
                <div class="table-responsive mgb-20">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th class="text-right"># &nbsp;</th>
                                <th style="width:60px;">Mã hành khách</th>
                                <th>Họ và Tên</th>
                                <th>Giới tính</th>
                                <th>Ngày sinh</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (bookPassengers != null && bookPassengers.Count() > 0)
                            {
                                int cnt = 0;
                                foreach (var item in bookPassengers.GroupBy(m => new { m.PassengerType }).Select(m => new { m.Key.PassengerType }))
                                {
                                    var list = bookPassengers.Where(m => m.PassengerType == item.PassengerType).ToList();
                                    string _rowspan = "";
                                    if (list.Count() > 1)
                                    {
                                        _rowspan = " rowspan=" + @list.Count();
                                    }

                                    for (int i = 0; i < list.Count(); i++)
                                    {
                                        cnt++;

                                        var gender = WebCore.Services.BookTicketService.ConvertToGenderName(list[i].Gender);
                                        <tr>
                                            <td class="text-right">@cnt &nbsp;</td>
                                            @if (i == 0)
                                            {
                                                <td style="vertical-align:middle;" @(i == 0 ? _rowspan : "")>- @list[i].PassengerType</td>
                                            }
                                            <td>@list[i].FullName</td>
                                            <td>@gender</td>
                                            <td>@list[i].DateOfBirth</td>
                                        </tr>
                                    }
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="top-pic mgb-10">
                    <label><i class="fa fa-info-circle" aria-hidden="true"></i> Chi phí:</label>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th class="text-right" style="width:100px;"># &nbsp;</th>
                                <th style="width:150px;">CHI PHÍ</th>
                                @if (bookPrices.Count > 0)
                                {
                                    foreach (var item in bookPrices)
                                    {
                                        <th>KH-@item.PassengerType </th>
                                    }
                                }
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th class="text-right">- &nbsp;</th>
                                <th style="width:60px;" colspan="4">Giá vé</th>
                            </tr>
                            <tr>
                                <th class="text-right"></th>
                                <th style="width:60px;" class="text-right">Tổng/1KH: </th>
                                @if (bookPrices.Count > 0)
                                {
                                    foreach (var item in bookPrices)
                                    {
                                        <td class="text-right">@Helper.Page.Library.FormatCurrency(item.Amount) đ &nbsp;</td>
                                    }
                                }
                            </tr>
                            <tr>
                                <th class="text-right">- &nbsp;</th>
                                <th style="width:60px;" colspan="4">Tax</th>
                            </tr>
                            @if (bookPrices.Count > 0)
                            {
                                List<string> taxCode = new List<string>();
                                for (int i = 0; i < bookPrices.Count; i++)
                                {
                                    //
                                    if (i == 0)
                                    {
                                        foreach (var item in bookPrices[i].FareTaxs)
                                        {
                                            taxCode.Add(item.TaxCode);
                                        }
                                    }
                                    if (taxCode.Count != 0 && taxCode.Count < bookPrices[i].FareTaxs.Count())
                                    {
                                        taxCode = new List<string>();
                                        foreach (var item in bookPrices[i].FareTaxs)
                                        {
                                            taxCode.Add(item.TaxCode);
                                        }
                                    }
                                }

                                if (taxCode.Count > 0)
                                {
                                    for (int i = 0; i < taxCode.Count; i++)
                                    {
                                        <tr>
                                            <td class="text-right"></td>
                                            <td class="text-right">@taxCode[i] / 1KH: </td>
                                            @foreach (var fare in bookPrices)
                                            {
                                                double amount = 0;
                                                var fareTaxs = fare.FareTaxs.Where(m => m.TaxCode == taxCode[i] && m.PassengerType == fare.PassengerType).FirstOrDefault();
                                                if (fareTaxs != null)
                                                {
                                                    amount = fareTaxs.Amount;
                                                }
                                                <td class="text-right">@Helper.Page.Library.FormatCurrency(amount) đ &nbsp;</td>
                                            }
                                        </tr>
                                    }
                                    <tr>
                                        <td class="text-right">-</td>
                                        <td class="text-right">Tổng/MKH</td>
                                        @foreach (var bookFare in bookFares)
                                        {
                                            double priceOfType = 0;
                                            double taxOfType = 0;
                                            double fareOfType = 0;
                                            var fare = bookFare.FareTaxs.Where(m => m.PassengerType == bookFare.PassengerType).FirstOrDefault();
                                            if (fare != null)
                                            {
                                                priceOfType = bookFare.PriceTotal;
                                                taxOfType = bookFare.TaxTotal;
                                                int passengerQty = bookFare.PassengerQty;

                                                fareOfType = (priceOfType + taxOfType) * passengerQty;

                                                ticketTotal += fareOfType;
                                            }
                                            <td class="text-right">@Helper.Page.Library.FormatCurrency(fareOfType) đ &nbsp;</td>
                                        }
                                    </tr>
                                }
                            }
                            <tr>
                                <td colspan="5" class="total-itinerary text-right"><label>Tổng:&nbsp; </label> <label class="text-right total-itinerary-price">@Helper.Page.Library.FormatCurrency(ticketTotal) đ &nbsp;</label></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="top-pic mgb-10">
                    <label><i class="fa fa-info-circle" aria-hidden="true"></i> Thông tin liên hệ:</label>
                </div>
                <div class="container-fluid mgb-20" style="background: #a2d5d0;">
                    <div class="row">
                        @if (bookContacts.Count > 0)
                        {
                            foreach (var item in bookContacts)
                            {
                                <div class="col-md-5">
                                    <div class="form-group mgt-20">
                                        <br />
                                        <label class="form-label">Họ tên: @item.Name</label>
                                    </div>
                                    <div class="form-group ">
                                        <label class="form-label">Số đ.thoại: @item.Phone</label>
                                    </div>
                                    <div class="form-group ">
                                        <label class="form-label">Địa chỉ e-mail:  @item.Email</label>
                                    </div>
                                </div>
                            }
                        }
                        <div class="col-md-12"> <hr /></div>
                    </div>
                </div>
            </section>
        }

    }
    catch (Exception)
    {
        @Html.Partial("~/Areas/Template/Views/_ViewNotPageLoadPatial.cshtml", null)
    }
    @section scripts{
        <script src="~/Areas/Management/_script/app-flight-booking.js"></script>
    }
}
